<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥åº·å°å¹«æ‰‹ ğŸ¦</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDloeMujdrabqiZI_9Wj4oRhTM7YfCAhec",
      authDomain: "health-companion-5758d.firebaseapp.com",
      databaseURL: "https://health-companion-5758d-default-rtdb.firebaseio.com",
      projectId: "health-companion-5758d",
      storageBucket: "health-companion-5758d.firebasestorage.app",
      messagingSenderId: "792398910828",
      appId: "1:792398910828:web:5adee6f456856bf6e04f49"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.db = db;
    window.ref = ref;
    window.set = set;
    window.get = get;
    window.onValue = onValue;
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #10b981;
      --primary-light: #34d399;
      --primary-dark: #059669;
      --secondary: #6366f1;
      --accent: #f59e0b;
      --danger: #ef4444;
      --dark: #1f2937;
      --dark-secondary: #374151;
      --gray: #9ca3af;
      --light: #f3f4f6;
      --white: #ffffff;
      --gradient: linear-gradient(135deg, #10b981 0%, #6366f1 100%);
      --shadow: 0 10px 40px rgba(0,0,0,0.1);
      --shadow-sm: 0 2px 10px rgba(0,0,0,0.05);
      --radius: 16px;
      --radius-sm: 10px;
    }
    
    body {
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gradient);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
    }
    
    .container { max-width: 700px; margin: 0 auto; }
    
    h1 {
      text-align: center;
      color: var(--white);
      margin-bottom: 8px;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 2px;
    }
    
    .subtitle {
      text-align: center;
      color: rgba(255,255,255,0.8);
      margin-bottom: 30px;
      font-size: 0.9rem;
    }
    
    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      animation: slideUp 0.4s ease-out;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card h2 {
      color: var(--dark);
      font-size: 1.2rem;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 3px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card h2::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--gradient);
      border-radius: 2px;
    }
    
    .form-group { margin-bottom: 20px; }
    
    .form-group label {
      display: block;
      font-weight: 500;
      color: var(--dark-secondary);
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: var(--white);
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    }
    
    .form-group input::placeholder { color: var(--gray); }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      width: 100%;
    }
    
    .btn-primary {
      background: var(--gradient);
      color: var(--white);
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .nav-tab {
      padding: 12px 20px;
      background: rgba(255,255,255,0.15);
      color: var(--white);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 30px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .nav-tab:hover { background: rgba(255,255,255,0.25); }
    
    .nav-tab.active {
      background: var(--white);
      color: var(--primary);
      border-color: var(--white);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .meal-section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 2px solid #e2e8f0;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .meal-section h3 {
      color: var(--secondary);
      margin-bottom: 16px;
      font-size: 1.1rem;
    }
    
    .meal-image {
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      margin-bottom: 12px;
    }
    
    .chart-container {
      position: relative;
      height: 250px;
      margin-bottom: 24px;
      padding: 20px;
      background: #fafafa;
      border-radius: var(--radius-sm);
    }
    
    .history-item {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: var(--radius-sm);
      padding: 18px;
      margin-bottom: 14px;
    }
    
    .history-date {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
    }
    
    .history-details {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }
    
    .history-details span {
      background: var(--white);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid #e5e7eb;
    }
    
    .time-range-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    .time-range-btn {
      padding: 10px 24px;
      border: 2px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .time-range-btn.active {
      background: var(--primary);
      color: var(--white);
    }
    
    .empty-state {
      text-align: center;
      padding: 50px 20px;
      color: var(--gray);
    }
    
    .profile-display {
      background: var(--gradient);
      color: white;
      padding: 24px;
      border-radius: var(--radius);
      margin-bottom: 24px;
      text-align: center;
    }
    
    .profile-display h3 { font-size: 1.4rem; }
    
    .sync-status {
      text-align: center;
      padding: 12px;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      color: var(--primary-dark);
    }
    
    .section-title {
      font-size: 0.85rem;
      color: var(--gray);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
      margin-top: 24px;
    }
    
    .section-title:first-of-type { margin-top: 0; }
    
    input[type="file"] {
      padding: 12px;
      background: var(--light);
      border-radius: var(--radius-sm);
    }
    
    @media (max-width: 600px) {
      body { padding: 12px; }
      .card { padding: 20px; }
      h1 { font-size: 1.5rem; }
      .form-row { grid-template-columns: 1fr; }
      .nav-tab { padding: 10px 16px; font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å¥åº·å°å¹«æ‰‹ ğŸ¦</h1>
    <p class="subtitle">è¨˜éŒ„å¥åº· Â· æŒæ¡è¶¨å‹¢ Â· å…±äº«é—œæ‡·</p>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('profile')">ğŸ‘¤ å€‹äººè³‡æ–™</button>
      <button class="nav-tab" onclick="showTab('daily')">ğŸ“ æ¯æ—¥è¨˜éŒ„</button>
      <button class="nav-tab" onclick="showTab('meals')">ğŸ½ï¸ é¤é£²è¨˜éŒ„</button>
      <button class="nav-tab" onclick="showTab('trends')">ğŸ“ˆ è¶¨å‹¢åˆ†æ</button>
      <button class="nav-tab" onclick="showTab('history')">ğŸ“š æ­·å²è³‡æ–™</button>
    </div>

    <!-- å€‹äººè³‡æ–™å€ -->
    <div id="profile" class="tab-content active">
      <div class="card">
        <h2>å€‹äººè³‡æ–™</h2>
        <div class="sync-status" id="syncStatus">æ­£åœ¨åŒæ­¥è³‡æ–™...</div>
        <div id="profileDisplay"></div>
        <div class="form-group">
          <label>å§“å</label>
          <input type="text" id="profileName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
        </div>
        <div class="form-group">
          <label>å¹´é½¡</label>
          <input type="number" id="profileAge" placeholder="è«‹è¼¸å…¥å¹´é½¡">
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">å„²å­˜è³‡æ–™</button>
      </div>
    </div>

    <!-- æ¯æ—¥è¨˜éŒ„å€ -->
    <div id="daily" class="tab-content">
      <div class="card">
        <h2>æ¯æ—¥å¥åº·è¨˜éŒ„</h2>
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="dailyDate">
        </div>
        
        <p class="section-title">èº«é«”æ•¸æ“š</p>
        <div class="form-row">
          <div class="form-group">
            <label>é«”é‡ (kg)</label>
            <input type="number" id="dailyWeight" step="0.1" placeholder="ä¾‹å¦‚ï¼š70.5">
          </div>
          <div class="form-group">
            <label>é«”è„‚ç‡ (%)</label>
            <input type="number" id="dailyBodyFat" step="0.1" placeholder="ä¾‹å¦‚ï¼š20.5">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å…§è‡Ÿè„‚è‚ª (1-9)</label>
            <input type="number" id="dailyVisceralFat" min="1" max="9" placeholder="1-9">
          </div>
          <div class="form-group">
            <label>æ°´é‡ (cc)</label>
            <input type="number" id="dailyWater" placeholder="ä¾‹å¦‚ï¼š2000">
          </div>
        </div>
        
        <p class="section-title">ä½œæ¯æ™‚é–“</p>
        <div class="form-row">
          <div class="form-group">
            <label>èµ·åºŠæ™‚é–“</label>
            <input type="time" id="dailyWakeTime">
          </div>
          <div class="form-group">
            <label>å°±å¯¢æ™‚é–“</label>
            <input type="time" id="dailySleepTime">
          </div>
        </div>
        
        <p class="section-title">å¥åº·æŒ‡æ¨™</p>
        <div class="form-row">
          <div class="form-group">
            <label>è¡€å£“æ”¶ç¸®å£“ (mmHg)</label>
            <input type="number" id="dailyBP_Sys" placeholder="ä¾‹å¦‚ï¼š120">
          </div>
          <div class="form-group">
            <label>è¡€å£“èˆ’å¼µå£“ (mmHg)</label>
            <input type="number" id="dailyBP_Dia" placeholder="ä¾‹å¦‚ï¼š80">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>æ’ä¾¿ç´€éŒ„</label>
            <select id="dailyBowel">
              <option value="">è«‹é¸æ“‡</option>
              <option value="true">æœ‰ âœ“</option>
              <option value="false">ç„¡ âœ—</option>
            </select>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="saveDailyRecord()">å„²å­˜è¨˜éŒ„</button>
      </div>
    </div>

    <!-- é¤é£²è¨˜éŒ„å€ -->
    <div id="meals" class="tab-content">
      <div class="card">
        <h2>é¤é£²è¨˜éŒ„</h2>
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="mealDate">
        </div>
        
        <div class="meal-section">
          <h3>ğŸŒ… æ—©é¤</h3>
          <input type="file" id="breakfastImage" accept="image/*" onchange="previewImage(this, 'breakfastPreview')">
          <div id="breakfastPreview"></div>
          <div class="form-group" style="margin-top: 12px;">
            <textarea id="breakfastNote" rows="2" placeholder="åƒäº†ä»€éº¼å¥½æ–™ï¼Ÿ"></textarea>
          </div>
        </div>

        <div class="meal-section">
          <h3>â˜€ï¸ åˆé¤</h3>
          <input type="file" id="lunchImage" accept="image/*" onchange="previewImage(this, 'lunchPreview')">
          <div id="lunchPreview"></div>
          <div class="form-group" style="margin-top: 12px;">
            <textarea id="lunchNote" rows="2" placeholder="åƒäº†ä»€éº¼å¥½æ–™ï¼Ÿ"></textarea>
          </div>
        </div>

        <div class="meal-section">
          <h3>ğŸŒ™ æ™šé¤</h3>
          <input type="file" id="dinnerImage" accept="image/*" onchange="previewImage(this, 'dinnerPreview')">
          <div id="dinnerPreview"></div>
          <div class="form-group" style="margin-top: 12px;">
            <textarea id="dinnerNote" rows="2" placeholder="åƒäº†ä»€éº¼å¥½æ–™ï¼Ÿ"></textarea>
          </div>
        </div>

        <button class="btn btn-primary" onclick="saveMealRecord()">å„²å­˜é¤é£²</button>
      </div>
    </div>

    <!-- è¶¨å‹¢åˆ†æå€ -->
    <div id="trends" class="tab-content">
      <div class="card">
        <h2>è¶¨å‹¢åˆ†æ</h2>
        <div class="time-range-selector">
          <button class="time-range-btn active" onclick="setTimeRange(7, this)">7å¤©</button>
          <button class="time-range-btn" onclick="setTimeRange(30, this)">30å¤©</button>
          <button class="time-range-btn" onclick="setTimeRange(90, this)">90å¤©</button>
        </div>
        
        <div class="chart-container">
          <canvas id="weightChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="bodyFatChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="bloodPressureChart"></canvas>
        </div>
      </div>
    </div>

    <!-- æ­·å²è³‡æ–™å€ -->
    <div id="history" class="tab-content">
      <div class="card">
        <h2>æ­·å²è³‡æ–™</h2>
        <div class="form-group">
          <label>æœå°‹æ—¥æœŸ</label>
          <input type="date" id="searchDate" onchange="searchHistory()">
        </div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    let db, ref, set, get, onValue;
    
    function waitForFirebase() {
      return new Promise((resolve) => {
        const check = () => {
          if (window.db) {
            db = window.db;
            ref = window.ref;
            set = window.set;
            get = window.get;
            onValue = window.onValue;
            resolve();
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });
    }

    let currentTimeRange = 7;
    let charts = {};
    let allData = { profile: {}, dailyRecords: [], mealRecords: [] };

    document.getElementById('dailyDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('mealDate').value = new Date().toISOString().split('T')[0];

    waitForFirebase().then(() => {
      setupRealtimeSync();
    });

    function setupRealtimeSync() {
      const statusEl = document.getElementById('syncStatus');
      
      onValue(ref(db, 'profile'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          allData.profile = data;
          loadProfileDisplay(data);
          statusEl.textContent = 'âœ“ è³‡æ–™å·²åŒæ­¥';
        } else {
          statusEl.textContent = 'âœ“ è³‡æ–™å·²åŒæ­¥';
        }
      });

      onValue(ref(db, 'dailyRecords'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          allData.dailyRecords = Object.values(data);
        } else {
          allData.dailyRecords = [];
        }
        loadHistory();
        if (document.getElementById('trends').classList.contains('active')) {
          updateCharts();
        }
      });

      onValue(ref(db, 'mealRecords'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          allData.mealRecords = Object.values(data);
        } else {
          allData.mealRecords = [];
        }
        loadHistory();
      });
    }

    window.showTab = function(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      
      if (tabId === 'trends') {
        setTimeout(updateCharts, 100);
      }
    };

    window.saveProfile = async function() {
      const profile = {
        name: document.getElementById('profileName').value,
        age: document.getElementById('profileAge').value
      };
      
      if (!profile.name) {
        alert('è«‹è¼¸å…¥å§“å');
        return;
      }
      
      await set(ref(db, 'profile'), profile);
      alert('å€‹äººè³‡æ–™å·²å„²å­˜ï¼');
    };

    function loadProfileDisplay(profile) {
      if (profile.name) {
        document.getElementById('profileName').value = profile.name;
        document.getElementById('profileAge').value = profile.age;
        document.getElementById('profileDisplay').innerHTML = `
          <div class="profile-display">
            <h3>ğŸ‘¤ ${profile.name}</h3>
            <p>${profile.age} æ­²</p>
          </div>
        `;
      }
    }

    window.saveDailyRecord = async function() {
      const date = document.getElementById('dailyDate').value;
      if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }

      const record = {
        date: date,
        weight: parseFloat(document.getElementById('dailyWeight').value) || null,
        bodyFat: parseFloat(document.getElementById('dailyBodyFat').value) || null,
        visceralFat: parseInt(document.getElementById('dailyVisceralFat').value) || null,
        wakeTime: document.getElementById('dailyWakeTime').value || null,
        sleepTime: document.getElementById('dailySleepTime').value || null,
        bloodPressure: {
          systolic: parseInt(document.getElementById('dailyBP_Sys').value) || null,
          diastolic: parseInt(document.getElementById('dailyBP_Dia').value) || null
        },
        bowelMovement: document.getElementById('dailyBowel').value === 'true' ? true : (document.getElementById('dailyBowel').value === 'false' ? false : null),
        waterIntake: parseInt(document.getElementById('dailyWater').value) || null
      };

      await set(ref(db, 'dailyRecords/' + date), record);
      alert('æ¯æ—¥è¨˜éŒ„å·²å„²å­˜ï¼');
    };

    window.previewImage = function(input, previewId) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById(previewId).innerHTML = `<img src="${e.target.result}" class="meal-image">`;
        };
        reader.readAsDataURL(file);
      }
    };

    window.saveMealRecord = async function() {
      const date = document.getElementById('mealDate').value;
      if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }

      const getImageBase64 = (inputId) => {
        const input = document.getElementById(inputId);
        if (input.files[0]) {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) { resolve(e.target.result); };
            reader.readAsDataURL(input.files[0]);
          });
        }
        return Promise.resolve(null);
      };

      Promise.all([
        getImageBase64('breakfastImage'),
        getImageBase64('lunchImage'),
        getImageBase64('dinnerImage')
      ]).then(([breakfastImg, lunchImg, dinnerImg]) => {
        const record = {
          date: date,
          breakfast: { image: breakfastImg, note: document.getElementById('breakfastNote').value },
          lunch: { image: lunchImg, note: document.getElementById('lunchNote').value },
          dinner: { image: dinnerImg, note: document.getElementById('dinnerNote').value }
        };

        set(ref(db, 'mealRecords/' + date), record);
        alert('é¤é£²è¨˜éŒ„å·²å„²å­˜ï¼');
      });
    };

    window.setTimeRange = function(days, btn) {
      currentTimeRange = days;
      document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateCharts();
    };

    function updateCharts() {
      const records = allData.dailyRecords;
      const now = new Date();
      const startDate = new Date(now.getTime() - currentTimeRange * 24 * 60 * 60 * 1000);
      
      const filteredRecords = records
        .filter(r => r.date && new Date(r.date) >= startDate)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = filteredRecords.map(r => r.date);
      
      if (labels.length === 0) {
        const container = document.querySelector('#trends .card');
        container.innerHTML = `
          <h2>è¶¨å‹¢åˆ†æ</h2>
          <div class="time-range-selector">
            <button class="time-range-btn active" onclick="setTimeRange(7, this)">7å¤©</button>
            <button class="time-range-btn" onclick="setTimeRange(30, this)">30å¤©</button>
            <button class="time-range-btn" onclick="setTimeRange(90, this)">90å¤©</button>
          </div>
          <div class="empty-state">
            <p>å°šç„¡è¶³å¤ è³‡æ–™é¡¯ç¤ºè¶¨å‹¢åœ–</p>
            <p style="font-size: 0.85rem; margin-top: 8px;">è«‹å…ˆè¨˜éŒ„å¹¾ç­†è³‡æ–™å¾Œå†ä¾†æŸ¥çœ‹</p>
          </div>
        `;
        return;
      }
      
      if (!document.getElementById('weightChart')) {
        const trendsCard = document.querySelector('#trends .card');
        trendsCard.innerHTML = `
          <h2>è¶¨å‹¢åˆ†æ</h2>
          <div class="time-range-selector">
            <button class="time-range-btn active" onclick="setTimeRange(7, this)">7å¤©</button>
            <button class="time-range-btn" onclick="setTimeRange(30, this)">30å¤©</button>
            <button class="time-range-btn" onclick="setTimeRange(90, this)">90å¤©</button>
          </div>
          <div class="chart-container"><canvas id="weightChart"></canvas></div>
          <div class="chart-container"><canvas id="bodyFatChart"></canvas></div>
          <div class="chart-container"><canvas id="bloodPressureChart"></canvas></div>
        `;
      }
      
      createChart('weightChart', 'é«”é‡è¶¨å‹¢ (kg)', labels, filteredRecords.map(r => r.weight), '#10b981');
      createChart('bodyFatChart', 'é«”è„‚ç‡è¶¨å‹¢ (%)', labels, filteredRecords.map(r => r.bodyFat), '#ef4444');
      createChart('bloodPressureChart', 'è¡€å£“è¶¨å‹¢ (mmHg)', labels, 
        filteredRecords.map(r => r.bloodPressure?.systolic), '#6366f1', 
        filteredRecords.map(r => r.bloodPressure?.diastolic));
    }

    function createChart(canvasId, label, labels, data, color, data2 = null) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;
      
      const context = ctx.getContext('2d');
      
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }

      const datasets = [{
        label: label,
        data: data,
        borderColor: color,
        backgroundColor: color + '20',
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointHoverRadius: 6
      }];

      if (data2) {
        datasets.push({
          label: label + ' (èˆ’å¼µå£“)',
          data: data2,
          borderColor: '#a78bfa',
          backgroundColor: '#a78bfa20',
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6
        });
      }

      charts[canvasId] = new Chart(context, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    function loadHistory() {
      const records = allData.dailyRecords;
      const mealRecords = allData.mealRecords;
      
      const historyList = document.getElementById('historyList');
      if (records.length === 0 && mealRecords.length === 0) {
        historyList.innerHTML = '<div class="empty-state"><p>å°šç„¡è¨˜éŒ„è³‡æ–™</p></div>';
        return;
      }

      let html = '';
      const allDates = [...new Set([...records.map(r => r.date), ...mealRecords.map(r => r.date)])].sort().reverse();

      allDates.forEach(date => {
        const daily = records.find(r => r.date === date);
        const meal = mealRecords.find(r => r.date === date);
        
        html += `<div class="history-item">
          <div class="history-date">ğŸ“… ${date}</div>`;
        
        if (daily) {
          html += `<div class="history-details">`;
          if (daily.weight) html += `<span>é«”é‡: ${daily.weight} kg</span>`;
          if (daily.bodyFat) html += `<span>é«”è„‚: ${daily.bodyFat}%</span>`;
          if (daily.visceralFat) html += `<span>å…§è‡Ÿè„‚è‚ª: ${daily.visceralFat}</span>`;
          if (daily.wakeTime) html += `<span>èµ·åºŠ: ${daily.wakeTime}</span>`;
          if (daily.sleepTime) html += `<span>å°±å¯¢: ${daily.sleepTime}</span>`;
          if (daily.bloodPressure?.systolic) html += `<span>è¡€å£“: ${daily.bloodPressure.systolic}/${daily.bloodPressure.diastolic}</span>`;
          if (daily.waterIntake) html += `<span>æ°´é‡: ${daily.waterIntake} cc</span>`;
          if (daily.bowelMovement !== null) html += `<span>æ’ä¾¿: ${daily.bowelMovement ? 'æœ‰ âœ“' : 'ç„¡ âœ—'}</span>`;
          html += `</div>`;
        }

        if (meal) {
          html += `<div style="margin-top: 12px; font-size: 0.9rem; color: #6366f1;">`;
          if (meal.breakfast?.note) html += `ğŸŒ… æ—©é¤: ${meal.breakfast.note} `;
          if (meal.lunch?.note) html += `â˜€ï¸ åˆé¤: ${meal.lunch.note} `;
          if (meal.dinner?.note) html += `ğŸŒ™ æ™šé¤: ${meal.dinner.note}`;
          html += `</div>`;
        }

        html += `</div>`;
      });

      historyList.innerHTML = html;
    }

    window.searchHistory = function() {
      const searchDate = document.getElementById('searchDate').value;
      if (!searchDate) {
        loadHistory();
        return;
      }

      const records = allData.dailyRecords;
      const mealRecords = allData.mealRecords;
      
      const daily = records.find(r => r.date === searchDate);
      const meal = mealRecords.find(r => r.date === searchDate);
      
      const historyList = document.getElementById('historyList');
      
      if (!daily && !meal) {
        historyList.innerHTML = `<div class="empty-state">${searchDate} å°šç„¡è¨˜éŒ„è³‡æ–™</div>`;
        return;
      }

      let html = `<div class="history-item">
        <div class="history-date">ğŸ“… ${searchDate}</div>`;
      
      if (daily) {
        html += `<div class="history-details">`;
        if (daily.weight) html += `<span>é«”é‡: ${daily.weight} kg</span>`;
        if (daily.bodyFat) html += `<span>é«”è„‚: ${daily.bodyFat}%</span>`;
        if (daily.visceralFat) html += `<span>å…§è‡Ÿè„‚è‚ª: ${daily.visceralFat}</span>`;
        if (daily.wakeTime) html += `<span>èµ·åºŠ: ${daily.wakeTime}</span>`;
        if (daily.sleepTime) html += `<span>å°±å¯¢: ${daily.sleepTime}</span>`;
        if (daily.bloodPressure?.systolic) html += `<span>è¡€å£“: ${daily.bloodPressure.systolic}/${daily.bloodPressure.diastolic}</span>`;
        if (daily.waterIntake) html += `<span>æ°´é‡: ${daily.waterIntake} cc</span>`;
        if (daily.bowelMovement !== null) html += `<span>æ’ä¾¿: ${daily.bowelMovement ? 'æœ‰ âœ“' : 'ç„¡ âœ—'}</span>`;
        html += `</div>`;
      }

      if (meal) {
        html += `<div style="margin-top: 12px; font-size: 0.9rem; color: #6366f1;">`;
        if (meal.breakfast?.note) html += `ğŸŒ… æ—©é¤: ${meal.breakfast.note} `;
        if (meal.lunch?.note) html += `â˜€ï¸ åˆé¤: ${meal.lunch.note} `;
        if (meal.dinner?.note) html += `ğŸŒ™ æ™šé¤: ${meal.dinner.note}`;
        html += `</div>`;
      }

      html += `</div>`;
      historyList.innerHTML = html;
    };
  </script>
</body>
</html>