<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¥åº·å°å¹«æ‰‹ ğŸ¦</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, push, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDloeMujdrabqiZI_9Wj4oRhTM7YfCAhec",
      authDomain: "health-companion-5758d.firebaseapp.com",
      databaseURL: "https://health-companion-5758d-default-rtdb.firebaseio.com",
      projectId: "health-companion-5758d",
      storageBucket: "health-companion-5758d.firebasestorage.app",
      messagingSenderId: "792398910828",
      appId: "1:792398910828:web:5adee6f456856bf6e04f49"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.db = db;
    window.ref = ref;
    window.set = set;
    window.get = get;
    window.onValue = onValue;
    window.push = push;
    window.update = update;
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #2ecc71;
      --primary-dark: #27ae60;
      --secondary: #3498db;
      --danger: #e74c3c;
      --warning: #f39c12;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --white: #ffffff;
      --shadow: 0 4px 15px rgba(0,0,0,0.1);
      --radius: 12px;
    }
    body {
      font-family: 'Segoe UI', 'PingFang TC', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    h1 {
      text-align: center;
      color: var(--white);
      margin-bottom: 30px;
      font-size: 2rem;
    }
    .card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }
    .card h2 {
      color: var(--dark);
      font-size: 1.3rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--primary);
    }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 6px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary {
      background: var(--secondary);
      color: var(--white);
    }
    .btn-danger {
      background: var(--danger);
      color: var(--white);
    }
    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .nav-tab {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .nav-tab.active {
      background: var(--white);
      color: var(--primary);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .meal-section {
      border: 2px dashed #ddd;
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
    }
    .meal-section h3 {
      color: var(--secondary);
      margin-bottom: 12px;
    }
    .meal-image {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    .history-item {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .history-date {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .history-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      font-size: 0.9rem;
    }
    .history-details span {
      background: var(--light);
      padding: 4px 8px;
      border-radius: 4px;
    }
    .time-range-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .time-range-btn {
      padding: 8px 16px;
      border: 2px solid var(--primary);
      background: transparent;
      color: var(--primary);
      border-radius: 20px;
      cursor: pointer;
    }
    .time-range-btn.active {
      background: var(--primary);
      color: var(--white);
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .profile-display {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      border-radius: var(--radius);
      margin-bottom: 20px;
    }
    .profile-display h3 { margin-bottom: 10px; }
    .sync-status {
      text-align: center;
      padding: 8px;
      background: var(--light);
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }
    .sync-status.synced { color: var(--primary); }
    .sync-status.syncing { color: var(--warning); }
    @media (max-width: 600px) {
      body { padding: 10px; }
      .card { padding: 16px; }
      h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å¥åº·å°å¹«æ‰‹ ğŸ¦</h1>
    
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab('profile')">ğŸ‘¤ å€‹äººè³‡æ–™</button>
      <button class="nav-tab" onclick="showTab('daily')">ğŸ“ æ¯æ—¥è¨˜éŒ„</button>
      <button class="nav-tab" onclick="showTab('meals')">ğŸ½ï¸ é¤é£²è¨˜éŒ„</button>
      <button class="nav-tab" onclick="showTab('trends')">ğŸ“ˆ è¶¨å‹¢åˆ†æ</button>
      <button class="nav-tab" onclick="showTab('history')">ğŸ“š æ­·å²è³‡æ–™</button>
    </div>

    <!-- å€‹äººè³‡æ–™å€ -->
    <div id="profile" class="tab-content active">
      <div class="card">
        <h2>å€‹äººè³‡æ–™</h2>
        <div class="sync-status" id="syncStatus">â˜ï¸ æ­£åœ¨åŒæ­¥...</div>
        <div id="profileDisplay"></div>
        <div class="form-group">
          <label>å§“å</label>
          <input type="text" id="profileName" placeholder="è«‹è¼¸å…¥å§“å">
        </div>
        <div class="form-group">
          <label>å¹´é½¡</label>
          <input type="number" id="profileAge" placeholder="è«‹è¼¸å…¥å¹´é½¡">
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">å„²å­˜å€‹äººè³‡æ–™</button>
      </div>
    </div>

    <!-- æ¯æ—¥è¨˜éŒ„å€ -->
    <div id="daily" class="tab-content">
      <div class="card">
        <h2>æ¯æ—¥å¥åº·è¨˜éŒ„</h2>
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="dailyDate">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>é«”é‡ (kg)</label>
            <input type="number" id="dailyWeight" step="0.1" placeholder="ä¾‹å¦‚ï¼š70.5">
          </div>
          <div class="form-group">
            <label>é«”è„‚ç‡ (%)</label>
            <input type="number" id="dailyBodyFat" step="0.1" placeholder="ä¾‹å¦‚ï¼š20.5">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å…§è‡Ÿè„‚è‚ª (1-9)</label>
            <input type="number" id="dailyVisceralFat" min="1" max="9" placeholder="1-9">
          </div>
          <div class="form-group">
            <label>æ°´é‡ (cc)</label>
            <input type="number" id="dailyWater" placeholder="ä¾‹å¦‚ï¼š2000">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>èµ·åºŠæ™‚é–“</label>
            <input type="time" id="dailyWakeTime">
          </div>
          <div class="form-group">
            <label>å°±å¯¢æ™‚é–“</label>
            <input type="time" id="dailySleepTime">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>è¡€å£“æ”¶ç¸®å£“ (mmHg)</label>
            <input type="number" id="dailyBP_Sys" placeholder="ä¾‹å¦‚ï¼š120">
          </div>
          <div class="form-group">
            <label>è¡€å£“èˆ’å¼µå£“ (mmHg)</label>
            <input type="number" id="dailyBP_Dia" placeholder="ä¾‹å¦‚ï¼š80">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>è¡€ç³– (mg/dL)</label>
            <input type="number" id="dailyBloodSugar" placeholder="ä¾‹å¦‚ï¼š100">
          </div>
          <div class="form-group">
            <label>æ’ä¾¿ç´€éŒ„</label>
            <select id="dailyBowel">
              <option value="">è«‹é¸æ“‡</option>
              <option value="true">æœ‰</option>
              <option value="false">ç„¡</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveDailyRecord()">å„²å­˜æ¯æ—¥è¨˜éŒ„</button>
      </div>
    </div>

    <!-- é¤é£²è¨˜éŒ„å€ -->
    <div id="meals" class="tab-content">
      <div class="card">
        <h2>é¤é£²è¨˜éŒ„</h2>
        <div class="form-group">
          <label>æ—¥æœŸ</label>
          <input type="date" id="mealDate">
        </div>
        
        <div class="meal-section">
          <h3>ğŸŒ… æ—©é¤</h3>
          <input type="file" id="breakfastImage" accept="image/*" onchange="previewImage(this, 'breakfastPreview')">
          <div id="breakfastPreview"></div>
          <div class="form-group" style="margin-top: 10px;">
            <label>å‚™è¨»</label>
            <textarea id="breakfastNote" rows="2" placeholder="åƒäº†ä»€éº¼ï¼Ÿ"></textarea>
          </div>
        </div>

        <div class="meal-section">
          <h3>â˜€ï¸ åˆé¤</h3>
          <input type="file" id="lunchImage" accept="image/*" onchange="previewImage(this, 'lunchPreview')">
          <div id="lunchPreview"></div>
          <div class="form-group" style="margin-top: 10px;">
            <label>å‚™è¨»</label>
            <textarea id="lunchNote" rows="2" placeholder="åƒäº†ä»€éº¼ï¼Ÿ"></textarea>
          </div>
        </div>

        <div class="meal-section">
          <h3>ğŸŒ™ æ™šé¤</h3>
          <input type="file" id="dinnerImage" accept="image/*" onchange="previewImage(this, 'dinnerPreview')">
          <div id="dinnerPreview"></div>
          <div class="form-group" style="margin-top: 10px;">
            <label>å‚™è¨»</label>
            <textarea id="dinnerNote" rows="2" placeholder="åƒäº†ä»€éº¼ï¼Ÿ"></textarea>
          </div>
        </div>

        <button class="btn btn-primary" onclick="saveMealRecord()">å„²å­˜é¤é£²è¨˜éŒ„</button>
      </div>
    </div>

    <!-- è¶¨å‹¢åˆ†æå€ -->
    <div id="trends" class="tab-content">
      <div class="card">
        <h2>è¶¨å‹¢åˆ†æ</h2>
        <div class="time-range-selector">
          <button class="time-range-btn active" onclick="setTimeRange(7, this)">7å¤©</button>
          <button class="time-range-btn" onclick="setTimeRange(30, this)">30å¤©</button>
          <button class="time-range-btn" onclick="setTimeRange(90, this)">90å¤©</button>
        </div>
        
        <div class="chart-container">
          <canvas id="weightChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="bodyFatChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="bloodPressureChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="bloodSugarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- æ­·å²è³‡æ–™å€ -->
    <div id="history" class="tab-content">
      <div class="card">
        <h2>æ­·å²è³‡æ–™</h2>
        <div class="form-group">
          <label>æœå°‹æ—¥æœŸ</label>
          <input type="date" id="searchDate" onchange="searchHistory()">
        </div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // ç­‰å¾… Firebase è¼‰å…¥å®Œæˆ
    let db, ref, set, get, onValue, push, update;
    
    function waitForFirebase() {
      return new Promise((resolve) => {
        const check = () => {
          if (window.db) {
            db = window.db;
            ref = window.ref;
            set = window.set;
            get = window.get;
            onValue = window.onValue;
            push = window.push;
            update = window.update;
            resolve();
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });
    }

    let currentTimeRange = 7;
    let charts = {};
    let allData = { profile: {}, dailyRecords: [], mealRecords: [] };

    // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
    document.getElementById('dailyDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('mealDate').value = new Date().toISOString().split('T')[0];

    // åˆå§‹åŒ–
    waitForFirebase().then(() => {
      setupRealtimeSync();
    });

    // è¨­å®šå³æ™‚åŒæ­¥
    function setupRealtimeSync() {
      const statusEl = document.getElementById('syncStatus');
      
      // ç›£è½ profile è®ŠåŒ–
      onValue(ref(db, 'profile'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          allData.profile = data;
          loadProfileDisplay(data);
          statusEl.textContent = 'â˜ï¸ å·²åŒæ­¥';
          statusEl.className = 'sync-status synced';
        } else {
          statusEl.textContent = 'â˜ï¸ å·²åŒæ­¥';
          statusEl.className = 'sync-status synced';
        }
      });

      // ç›£è½æ¯æ—¥è¨˜éŒ„è®ŠåŒ–
      onValue(ref(db, 'dailyRecords'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          allData.dailyRecords = Object.values(data);
        } else {
          allData.dailyRecords = [];
        }
        loadHistory();
        if (document.getElementById('trends').classList.contains('active')) {
          updateCharts();
        }
      });

      // ç›£è½é¤é£²è¨˜éŒ„è®ŠåŒ–
      onValue(ref(db, 'mealRecords'), (snapshot) => {
        const data = snapshot.val();
        if (data) {
          allData.mealRecords = Object.values(data);
        } else {
          allData.mealRecords = [];
        }
        loadHistory();
      });
    }

    window.showTab = function(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
      
      if (tabId === 'trends') {
        updateCharts();
      }
    };

    // ========== å€‹äººè³‡æ–™ ==========
    window.saveProfile = async function() {
      const profile = {
        name: document.getElementById('profileName').value,
        age: document.getElementById('profileAge').value
      };
      
      await set(ref(db, 'profile'), profile);
      alert('å€‹äººè³‡æ–™å·²å„²å­˜ï¼');
    };

    function loadProfileDisplay(profile) {
      if (profile.name) {
        document.getElementById('profileName').value = profile.name;
        document.getElementById('profileAge').value = profile.age;
        document.getElementById('profileDisplay').innerHTML = `
          <div class="profile-display">
            <h3>ğŸ‘¤ ${profile.name}ï¼Œ${profile.age} æ­²</h3>
          </div>
        `;
      }
    }

    // ========== æ¯æ—¥è¨˜éŒ„ ==========
    window.saveDailyRecord = async function() {
      const date = document.getElementById('dailyDate').value;
      if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }

      const record = {
        date: date,
        weight: parseFloat(document.getElementById('dailyWeight').value) || null,
        bodyFat: parseFloat(document.getElementById('dailyBodyFat').value) || null,
        visceralFat: parseInt(document.getElementById('dailyVisceralFat').value) || null,
        wakeTime: document.getElementById('dailyWakeTime').value || null,
        sleepTime: document.getElementById('dailySleepTime').value || null,
        bloodPressure: {
          systolic: parseInt(document.getElementById('dailyBP_Sys').value) || null,
          diastolic: parseInt(document.getElementById('dailyBP_Dia').value) || null
        },
        bloodSugar: parseInt(document.getElementById('dailyBloodSugar').value) || null,
        bowelMovement: document.getElementById('dailyBowel').value === 'true' ? true : (document.getElementById('dailyBowel').value === 'false' ? false : null),
        waterIntake: parseInt(document.getElementById('dailyWater').value) || null
      };

      // ä½¿ç”¨æ—¥æœŸä½œç‚º key
      await set(ref(db, 'dailyRecords/' + date), record);
      alert('æ¯æ—¥è¨˜éŒ„å·²å„²å­˜ï¼');
    };

    // ========== é¤é£²è¨˜éŒ„ ==========
    window.previewImage = function(input, previewId) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById(previewId).innerHTML = `<img src="${e.target.result}" class="meal-image">`;
        };
        reader.readAsDataURL(file);
      }
    };

    window.saveMealRecord = async function() {
      const date = document.getElementById('mealDate').value;
      if (!date) { alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }

      const getImageBase64 = (inputId) => {
        const input = document.getElementById(inputId);
        if (input.files[0]) {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) { resolve(e.target.result); };
            reader.readAsDataURL(input.files[0]);
          });
        }
        return Promise.resolve(null);
      };

      Promise.all([
        getImageBase64('breakfastImage'),
        getImageBase64('lunchImage'),
        getImageBase64('dinnerImage')
      ]).then(([breakfastImg, lunchImg, dinnerImg]) => {
        const record = {
          date: date,
          breakfast: { image: breakfastImg, note: document.getElementById('breakfastNote').value },
          lunch: { image: lunchImg, note: document.getElementById('lunchNote').value },
          dinner: { image: dinnerImg, note: document.getElementById('dinnerNote').value }
        };

        set(ref(db, 'mealRecords/' + date), record);
        alert('é¤é£²è¨˜éŒ„å·²å„²å­˜ï¼');
      });
    };

    // ========== è¶¨å‹¢åˆ†æ ==========
    window.setTimeRange = function(days, btn) {
      currentTimeRange = days;
      document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateCharts();
    };

    function updateCharts() {
      const records = allData.dailyRecords;
      const now = new Date();
      const startDate = new Date(now.getTime() - currentTimeRange * 24 * 60 * 60 * 1000);
      
      const filteredRecords = records
        .filter(r => r.date && new Date(r.date) >= startDate)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = filteredRecords.map(r => r.date);
      
      if (labels.length === 0) {
        document.getElementById('weightChart').parentElement.innerHTML = '<div class="empty-state">å°šç„¡è¶³å¤ è³‡æ–™é¡¯ç¤ºè¶¨å‹¢åœ–</div>';
        return;
      }
      
      // æ¢å¾© chart container
      if (!document.getElementById('weightChart')) {
        const trendsCard = document.querySelector('#trends .card');
        trendsCard.innerHTML = `
          <h2>è¶¨å‹¢åˆ†æ</h2>
          <div class="time-range-selector">
            <button class="time-range-btn active" onclick="setTimeRange(7, this)">7å¤©</button>
            <button class="time-range-btn" onclick="setTimeRange(30, this)">30å¤©</button>
            <button class="time-range-btn" onclick="setTimeRange(90, this)">90å¤©</button>
          </div>
          <div class="chart-container"><canvas id="weightChart"></canvas></div>
          <div class="chart-container"><canvas id="bodyFatChart"></canvas></div>
          <div class="chart-container"><canvas id="bloodPressureChart"></canvas></div>
          <div class="chart-container"><canvas id="bloodSugarChart"></canvas></div>
        `;
      }
      
      // é«”é‡
      createChart('weightChart', 'é«”é‡è¶¨å‹¢ (kg)', labels, 
        filteredRecords.map(r => r.weight), '#2ecc71');
      // é«”è„‚ç‡
      createChart('bodyFatChart', 'é«”è„‚ç‡è¶¨å‹¢ (%)', labels, 
        filteredRecords.map(r => r.bodyFat), '#e74c3c');
      // è¡€å£“
      createChart('bloodPressureChart', 'è¡€å£“è¶¨å‹¢ (mmHg)', labels, 
        filteredRecords.map(r => r.bloodPressure?.systolic), '#3498db', 
        filteredRecords.map(r => r.bloodPressure?.diastolic));
      // è¡€ç³–
      createChart('bloodSugarChart', 'è¡€ç³–è¶¨å‹¢ (mg/dL)', labels, 
        filteredRecords.map(r => r.bloodSugar), '#f39c12');
    }

    function createChart(canvasId, label, labels, data, color, data2 = null) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }

      const datasets = [{
        label: label,
        data: data,
        borderColor: color,
        backgroundColor: color + '20',
        fill: true,
        tension: 0.4
      }];

      if (data2) {
        datasets.push({
          label: label + ' (èˆ’å¼µå£“)',
          data: data2,
          borderColor: '#9b59b6',
          backgroundColor: '#9b59b620',
          fill: true,
          tension: 0.4
        });
      }

      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    // ========== æ­·å²è³‡æ–™ ==========
    function loadHistory() {
      const records = allData.dailyRecords;
      const mealRecords = allData.mealRecords;
      
      const historyList = document.getElementById('historyList');
      if (records.length === 0 && mealRecords.length === 0) {
        historyList.innerHTML = '<div class="empty-state">å°šç„¡è¨˜éŒ„è³‡æ–™</div>';
        return;
      }

      let html = '';
      const allDates = [...new Set([...records.map(r => r.date), ...mealRecords.map(r => r.date)])].sort().reverse();

      allDates.forEach(date => {
        const daily = records.find(r => r.date === date);
        const meal = mealRecords.find(r => r.date === date);
        
        html += `<div class="history-item">
          <div class="history-date">ğŸ“… ${date}</div>`;
        
        if (daily) {
          html += `<div class="history-details">`;
          if (daily.weight) html += `<span>é«”é‡: ${daily.weight} kg</span>`;
          if (daily.bodyFat) html += `<span>é«”è„‚: ${daily.bodyFat}%</span>`;
          if (daily.visceralFat) html += `<span>å…§è‡Ÿè„‚è‚ª: ${daily.visceralFat}</span>`;
          if (daily.wakeTime) html += `<span>èµ·åºŠ: ${daily.wakeTime}</span>`;
          if (daily.sleepTime) html += `<span>å°±å¯¢: ${daily.sleepTime}</span>`;
          if (daily.bloodPressure?.systolic) html += `<span>è¡€å£“: ${daily.bloodPressure.systolic}/${daily.bloodPressure.diastolic}</span>`;
          if (daily.bloodSugar) html += `<span>è¡€ç³–: ${daily.bloodSugar}</span>`;
          if (daily.waterIntake) html += `<span>æ°´é‡: ${daily.waterIntake} cc</span>`;
          if (daily.bowelMovement !== null) html += `<span>æ’ä¾¿: ${daily.bowelMovement ? 'æœ‰' : 'ç„¡'}</span>`;
          html += `</div>`;
        }

        if (meal) {
          html += `<div style="margin-top: 8px; font-size: 0.85rem; color: #666;">`;
          if (meal.breakfast?.note) html += `ğŸŒ… æ—©é¤: ${meal.breakfast.note} `;
          if (meal.lunch?.note) html += `â˜€ï¸ åˆé¤: ${meal.lunch.note} `;
          if (meal.dinner?.note) html += `ğŸŒ™ æ™šé¤: ${meal.dinner.note}`;
          html += `</div>`;
        }

        html += `</div>`;
      });

      historyList.innerHTML = html;
    }

    window.searchHistory = function() {
      const searchDate = document.getElementById('searchDate').value;
      if (!searchDate) {
        loadHistory();
        return;
      }

      const records = allData.dailyRecords;
      const mealRecords = allData.mealRecords;
      
      const daily = records.find(r => r.date === searchDate);
      const meal = mealRecords.find(r => r.date === searchDate);
      
      const historyList = document.getElementById('historyList');
      
      if (!daily && !meal) {
        historyList.innerHTML = `<div class="empty-state">${searchDate} å°šç„¡è¨˜éŒ„è³‡æ–™</div>`;
        return;
      }

      let html = `<div class="history-item">
        <div class="history-date">ğŸ“… ${searchDate}</div>`;
      
      if (daily) {
        html += `<div class="history-details">`;
        if (daily.weight) html += `<span>é«”é‡: ${daily.weight} kg</span>`;
        if (daily.bodyFat) html += `<span>é«”è„‚: ${daily.bodyFat}%</span>`;
        if (daily.visceralFat) html += `<span>å…§è‡Ÿè„‚è‚ª: ${daily.visceralFat}</span>`;
        if (daily.wakeTime) html += `<span>èµ·åºŠ: ${daily.wakeTime}</span>`;
        if (daily.sleepTime) html += `<span>å°±å¯¢: ${daily.sleepTime}</span>`;
        if (daily.bloodPressure?.systolic) html += `<span>è¡€å£“: ${daily.bloodPressure.systolic}/${daily.bloodPressure.diastolic}</span>`;
        if (daily.bloodSugar) html += `<span>è¡€ç³–: ${daily.bloodSugar}</span>`;
        if (daily.waterIntake) html += `<span>æ°´é‡: ${daily.waterIntake} cc</span>`;
        if (daily.bowelMovement !== null) html += `<span>æ’ä¾¿: ${daily.bowelMovement ? 'æœ‰' : 'ç„¡'}</span>`;
        html += `</div>`;
      }

      if (meal) {
        html += `<div style="margin-top: 8px; font-size: 0.85rem; color: #666;">`;
        if (meal.breakfast?.note) html += `ğŸŒ… æ—©é¤: ${meal.breakfast.note} `;
        if (meal.lunch?.note) html += `â˜€ï¸ åˆé¤: ${meal.lunch.note} `;
        if (meal.dinner?.note) html += `ğŸŒ™ æ™šé¤: ${meal.dinner.note}`;
        html += `</div>`;
      }

      html += `</div>`;
      historyList.innerHTML = html;
    };
  </script>
</body>
</html>
